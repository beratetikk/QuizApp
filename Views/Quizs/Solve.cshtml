@model SolveQuizViewModel

<style>
    .option-box {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 10px;
        background: #fff;
    }

    .question-image {
        max-width: 100%;
        max-height: 380px;
        width: auto;
        height: auto;
        object-fit: contain;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 6px;
        background: white;
        display: block;
    }

    .wrap-anywhere {
        overflow-wrap: anywhere;
        word-break: break-word;
        white-space: normal;
    }

    .review-card {
        border: 1px solid #eee;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
        margin-bottom: 14px;
    }

    .chip {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ddd;
        white-space: nowrap;
    }
</style>

<div class="container mt-4">

    @if (Model.IsFinished)
    {
        var wrong = (Model.TotalQuestions - Model.CorrectCount - Model.BlankCount);

        <h3 class="mb-3">Quiz Tamamlandı</h3>

        <div class="row g-3">
            <div class="col-md-4">
                <div class="alert alert-success mb-0">
                    <strong>Doğru:</strong> @Model.CorrectCount
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-danger mb-0">
                    <strong>Yanlış:</strong> @wrong
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-secondary mb-0">
                    <strong>Boş:</strong> @Model.BlankCount
                </div>
            </div>
        </div>

        <div class="alert alert-primary mt-3">
            <strong>Toplam:</strong> @Model.TotalQuestions
        </div>

        <div class="d-flex flex-wrap gap-2 mt-2">
            <a asp-action="Index" class="btn btn-secondary">Sınavlara Dön</a>
            <a asp-controller="Home" asp-action="OgrenciHome" class="btn btn-outline-primary">Öğrenci Paneli</a>
        </div>

        @* Review *@
        @if (Model.ReviewMode && Model.ReviewItems != null && Model.ReviewItems.Any())
        {
            <hr class="my-4" />
            <h4 class="mb-3">Soruları İncele</h4>

            @foreach (var item in Model.ReviewItems.OrderBy(x => x.QuestionNum))
            {
                bool isBlank = string.IsNullOrWhiteSpace(item.SelectedOption);
                bool isCorrect = (!isBlank && item.SelectedOption == item.CorrectOption);

                <div class="review-card">
                    <div class="d-flex justify-content-between align-items-start gap-2">
                        <div class="fw-bold wrap-anywhere">
                            @item.QuestionNum) @item.Text
                        </div>
                        <div class="ms-2">
                            @if (isBlank) { <span class="chip">Boş</span> }
                            else if (isCorrect) { <span class="chip">Doğru</span> }
                            else { <span class="chip">Yanlış</span> }
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(item.ImagePath))
                    {
                        <div class="mt-2">
                            <img src="@item.ImagePath" class="question-image" alt="Soru Resmi" />
                        </div>
                    }

                    <div class="mt-3">
                        <div class="small text-muted mb-2">
                            <strong>Doğru Şık:</strong> @item.CorrectOption
                            &nbsp; | &nbsp;
                            <strong>Senin Seçimin:</strong> @(isBlank ? "-" : item.SelectedOption)
                        </div>

                        @{
                            var opts = new List<(string Key, string? Text)>
                            {
                                ("A", item.ChoiceA),
                                ("B", item.ChoiceB),
                                ("C", item.ChoiceC),
                                ("D", item.ChoiceD),
                                ("E", item.ChoiceE)
                            };
                        }

                        @foreach (var o in opts)
                        {
                            if (!string.IsNullOrWhiteSpace(o.Text))
                            {
                                var isThisCorrect = (o.Key == item.CorrectOption);
                                var isThisSelected = (!isBlank && o.Key == item.SelectedOption);

                                <div class="option-box">
                                    <div class="d-flex justify-content-between gap-2">
                                        <div class="wrap-anywhere">
                                            <strong>@o.Key)</strong> @o.Text
                                        </div>
                                        <div class="d-flex gap-1 flex-wrap">
                                            @if (isThisCorrect) { <span class="chip">Doğru</span> }
                                            @if (isThisSelected) { <span class="chip">Seçtin</span> }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        }
    }
    else
    {

        @if (TempData["SolveError"] != null)
        {
            <div class="alert alert-danger">@TempData["SolveError"]</div>
        }

        @if (Model.TimeLimitMinutes.HasValue && Model.TimeLimitMinutes.Value > 0)
        {
            <div class="alert alert-warning d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div><strong>Süre:</strong> <span id="timerText"></span></div>
                <div class="text-muted small">Süre biterse sınav otomatik biter.</div>
            </div>

            <script>
                (function () {
                    let remaining = @Model.RemainingSeconds;

                    function fmt(sec) {
                        const m = Math.floor(sec / 60);
                        const s = sec % 60;
                        return `${m}:${String(s).padStart(2, '0')}`;
                    }

                    function tick() {
                        const el = document.getElementById("timerText");
                        if (el) el.textContent = fmt(Math.max(0, remaining));

                        if (remaining <= 0) {  
                            location.reload();
                            return;
                        }
                        remaining--;
                        setTimeout(tick, 1000);
                    }
                    tick();
                })();
            </script>
        }

        <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-muted mb-0">
                Soru @(Model.Order + 1) / @Model.TotalQuestions
            </p>

            <a asp-action="Index" class="btn btn-outline-danger btn-sm">
                Vazgeç
            </a>
        </div>

        <form asp-action="Solve" method="post">
            @Html.AntiForgeryToken()

            <input type="hidden" name="quizId" value="@Model.QuizId" />
            <input type="hidden" name="order" value="@Model.Order" />

            <div class="fs-4 wrap-anywhere">
                <strong>@(Model.Order + 1).</strong>
                @Model.CurrentQuestion.Text
            </div>

            @if (Model.CurrentQuestion != null && !string.IsNullOrWhiteSpace(Model.CurrentQuestion.ImagePath))
            {
                <div class="mb-3 mt-2">
                    <img src="@Model.CurrentQuestion.ImagePath" class="question-image" alt="Soru Resmi" />
                </div>
            }

            <div class="row">
                <div class="col-lg-8 col-md-10">
                    @{
                        var q = Model.CurrentQuestion;

                        bool anyOption =
                            !string.IsNullOrWhiteSpace(q?.ChoiceA) ||
                            !string.IsNullOrWhiteSpace(q?.ChoiceB) ||
                            !string.IsNullOrWhiteSpace(q?.ChoiceC) ||
                            !string.IsNullOrWhiteSpace(q?.ChoiceD) ||
                            !string.IsNullOrWhiteSpace(q?.ChoiceE);

                        bool requiredSet = false;
                    }

                    @if (!anyOption)
                    {
                        <div class="alert alert-warning">
                            Bu sorunun şıkları boş görünüyor. (ChoiceA/ChoiceB/... alanlarını kontrol et)
                        </div>
                    }
                    else
                    {
                        if (!string.IsNullOrWhiteSpace(q.ChoiceA))
                        {
                            <div class="option-box">
                                <label class="wrap-anywhere" style="cursor:pointer; width:100%;">
                                    <input type="radio" name="selected" value="A"
                                           @(!requiredSet ? "required" : "")
                                           @(Model.SelectedOption == "A" ? "checked" : "") />
                                    <strong>A)</strong> @q.ChoiceA
                                </label>
                            </div>
                            requiredSet = true;
                        }

                        if (!string.IsNullOrWhiteSpace(q.ChoiceB))
                        {
                            <div class="option-box">
                                <label class="wrap-anywhere" style="cursor:pointer; width:100%;">
                                    <input type="radio" name="selected" value="B"
                                           @(!requiredSet ? "required" : "")
                                           @(Model.SelectedOption == "B" ? "checked" : "") />
                                    <strong>B)</strong> @q.ChoiceB
                                </label>
                            </div>
                            requiredSet = true;
                        }

                        if (!string.IsNullOrWhiteSpace(q.ChoiceC))
                        {
                            <div class="option-box">
                                <label class="wrap-anywhere" style="cursor:pointer; width:100%;">
                                    <input type="radio" name="selected" value="C"
                                           @(!requiredSet ? "required" : "")
                                           @(Model.SelectedOption == "C" ? "checked" : "") />
                                    <strong>C)</strong> @q.ChoiceC
                                </label>
                            </div>
                            requiredSet = true;
                        }

                        if (!string.IsNullOrWhiteSpace(q.ChoiceD))
                        {
                            <div class="option-box">
                                <label class="wrap-anywhere" style="cursor:pointer; width:100%;">
                                    <input type="radio" name="selected" value="D"
                                           @(!requiredSet ? "required" : "")
                                           @(Model.SelectedOption == "D" ? "checked" : "") />
                                    <strong>D)</strong> @q.ChoiceD
                                </label>
                            </div>
                            requiredSet = true;
                        }

                        if (!string.IsNullOrWhiteSpace(q.ChoiceE))
                        {
                            <div class="option-box">
                                <label class="wrap-anywhere" style="cursor:pointer; width:100%;">
                                    <input type="radio" name="selected" value="E"
                                           @(!requiredSet ? "required" : "")
                                           @(Model.SelectedOption == "E" ? "checked" : "") />
                                    <strong>E)</strong> @q.ChoiceE
                                </label>
                            </div>
                            requiredSet = true;
                        }
                    }

                    <div class="d-flex gap-2 mt-2">
                        @if (Model.Order > 0)
                        {
                            <a class="btn btn-outline-secondary"
                               asp-action="Solve"
                               asp-route-quizId="@Model.QuizId"
                               asp-route-order="@(Model.Order - 1)">
                                Geri
                            </a>
                        }

                        <button type="submit" class="btn btn-primary ms-auto" @(anyOption ? "" : "disabled")>
                            Sonraki
                        </button>
                    </div>
                </div>
            </div>
        </form>
    }
</div>
